<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</head>
<body>
<h1>Welcome to your Dashboard : <span th:text="${shopkeepers.websiteName}" style="text-decoration: darkblue underline;"></span></h1>
<div class="card">
    <p th:text="${shopkeepers.firstName}"></p>
    <p th:text="${shopkeepers.lastName}"></p>
    <p th:text="${shopkeepers.email}"></p>
    <img th:src="@{${shopkeepers.profilePicture}}" alt="Photo de profil" style="width: 150px; height: 150px; border-radius: 50%;"/>
    <a href="/shopkeeper/accountUpdate"><button>Modifier</button></a>
</div>
<hr>

<!-- AJOUTER CATEGORIE: Bouton pour ouvrir la fenêtre modale -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addCategoryModal">
    Ajouter une catégorie
</button>





<!-- AJOUTER CATEGORIE: Fenêtre modale pour ajouter une catégorie -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Ajouter une catégorie</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <div class="form-group">
                        <label for="categoryName">Nom de la catégorie:</label>
                        <input type="text" class="form-control" id="categoryName" name="categoryName" required>
                    </div>
                    <div id="subcategoriesContainer">
                        <div class="form-group">
                            <label for="subcategories1">Sous-catégorie 1:</label>
                            <input type="text" class="form-control" id="subcategories1" name="subcategories">
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" id="addSubcategory">Ajouter une sous-catégorie</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="submitCategory">Ajouter</button>
            </div>
        </div>
    </div>
</div>

<div th:each="category : ${categoryList}" style="border: 1px solid black; margin-top: 2vh; margin-bottom: 2vh;">
    <h1 th:text="${category.CategoryName}" style="padding: 1.2vh;"></h1>
    <a th:href="'/shopkeeper/updateCategory?id=' + ${category.id}"><button>Modifier Catégorie</button></a>
    <a th:href="'/shopkeeper/supprCategory?id=' + ${category.id}"><button>Supprimer Catégorie</button></a>
    <a th:href="'/shopkeeper/addSubcategory?id=' + ${category.id}"><button>Ajout Sous Catégorie</button></a>

    <div th:each="subCategory : ${subCategoryList}" th:if="${subCategory.id_category == category.id}" style="border: 1px solid black;">
        <h2 th:text="${subCategory.SubCategoryName}" style="padding: 0.8vh; padding-left: 15vh;"></h2>
        <a th:href="'/shopkeeper/updateSubcategory?id=' + ${subCategory.id}"><button>Modifier Sous Catégorie</button></a>
        <a th:href="'/shopkeeper/supprSubcategory?id=' + ${subCategory.id}"><button>Supprimer Sous Catégorie</button></a>

        <!--  AJOUT PRODUIT: ci-dessous transmission de l'id de la sous-catégorie du produit en "hidden" et du csrf token   -->
        <form method="post" action="/products/newProduct">
            <input type="hidden" th:value="${subCategory.id}" name="id_subcategory">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button>Ajout Produit</button>
        </form>

            <!-- AFFICHAGE PRODUITS -->
            <div th:each="product : ${productList}" th:if="${product.id_subCategory == subCategory.id}" style="border: 1px solid black;">
                <p th:text="${product.productName}" style="padding: 0.6vh; margin-left: 25vh; margin-right: 25vh; font-weight: bold; font-size: large"></p>
                <p th:text="'Description : ' + ${product.description}" style="padding: 0.6vh; margin-left: 25vh; margin-right: 25vh;"></p>
                <p th:text="'Stock : ' + ${product.stock}" style="padding: 0.6vh; margin-left: 25vh; margin-right: 25vh;"></p>
                <p th:text="'Prix : ' + ${product.price}+ ' €'" style="padding: 0.6vh; margin-left: 25vh; margin-right: 25vh;"></p>
                <p><img th:src="@{${product.image}}" th:alt="'image de '+ ${product.productName}" style="width: 150px; height: 150px;"/></p>

            <!-- MODIFICATION PRODUIT -->
                <form method="post" action="/products/updateProduct" >
                    <input type="hidden" th:value="${product.id}" name="productid">
                    <input type="hidden" th:value="${subCategory.id}" name="id_subcategory">
                    <input type="hidden" th:value="${product.productName}" name="productName">
                    <input type="hidden" th:value="${product.description}" name="productdescription">
                    <input type="hidden" th:value="${product.price}" name="productprice">
                    <input type="hidden" th:value="${product.stock}" name="productstock">
                    <input type="hidden" th:value="${product.image}" name="file">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!--MODIFICATION PRODUIT: Bouton pour ouvrir la fenêtre modale -->
                    <!--- transmettre id produit ici! -->

                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#updateProductModal">
                        Modifier Produit
                    </button>
                </form>

            <!-- MODIFICATION PRODUIT: Fenêtre modale-->
                <div class="modal fade" id="updateProductModal" tabindex="-1" role="dialog" aria-labelledby="updateProductModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="updateProductModalLabel">Modifier un Produit</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="productForm" method="post" action="/products/updateProduct" enctype="multipart/form-data">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <div class="form-group">
                                        <label for="productName">Nom du Produit:</label>
                                        <input type="text" th:value="${productName}" class="form-control" id="productName" name="productName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="productDescription">Description:</label>
                                        <textarea class="form-control" id="productDescription" name="productdescription" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="productPrice">Prix:</label>
                                        <input type="number" class="form-control" id="productPrice" name="productprice" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="productStock">Stock:</label>
                                        <input type="number" class="form-control" id="productStock" name="productstock" required>
                                    </div>
                                    <div class="form-group">

                                        <label for="file">Choisir une image produit:</label>
                                        <input type="file" class="form-control" id="file" name="file" accept="image/png, image/jpeg, image/gif" required/><br>

                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                                <button type="button" class="btn btn-primary" id="submitProduct">Modifier</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--  SUPPRESSION PRODUIT: ci-dessous transmission de l'id et du nom du produit en "hidden" ainsi du csrf token   -->
            <form method="post" action="/products/deleteProduct">
                <input type="hidden" th:value="${product.id}" name="productid">
                <input type="hidden" th:value="${product.productName}" name="productName">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button>supprimer Produit</button>
            </form>

        </div>
    </div>
</div>

<!--
le script javascript ci-dessous gère l'ajout des sous-catég dans une fenêtre modale et envoie les dnnées au serveur via une requête ajax.
le nom du site web est récupéré à partir de thymeleaf ( [[${shopkeepers.websiteName}]] ).
-->

<script th:inline="javascript">
    $(document).ready(function() {
        var subcategoryCounter = 1;

        $('#addSubcategory').click(function() {
            subcategoryCounter++;
            var newSubcategory = `
                <div class="form-group">
                    <label for="subcategories${subcategoryCounter}">Sous-catégorie ${subcategoryCounter}:</label>
                    <input type="text" class="form-control" id="subcategories${subcategoryCounter}" name="subcategories">
                </div>
            `;
            $('#subcategoriesContainer').append(newSubcategory);
        });

        $('#submitCategory').click(function() {
            var categoryName = $('#categoryName').val();
            var subcategories = [];
            $('input[name="subcategories"]').each(function() {
                subcategories.push($(this).val());
            });

            var websiteName = [[${shopkeepers.websiteName}]];
            var csrfToken = $("input[name='_csrf']").val();

            $.ajax({
                url: '/categories',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken
                },
                data: {
                    action: 'ajoutcateg',
                    website_name: websiteName,
                    categories1: categoryName,
                    subcategories: subcategories
                },
                success: function(response) {
                    alert('Catégorie ajoutée avec succès!');
                    $('#addCategoryModal').modal('hide');

                },
                error: function(error) {
                    alert('Erreur lors de l\'ajout de la catégorie.');
                }
            });
        });
    });

    $(document).ready(function() {
        $('#updateProductModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget); // Bouton qui a déclenché la modal
            var productId = button.data('product-id'); // Récupérer l'ID du produit
            var modal = $(this);

            // Charger les données du produit via AJAX ou directement depuis les champs cachés
            var productName = button.closest('form').find('input[name="productName"]').val();
            var productDescription = button.closest('form').find('input[name="productdescription"]').val();
            var productPrice = button.closest('form').find('input[name="productprice"]').val();
            var productStock = button.closest('form').find('input[name="productstock"]').val();
            var productImage = button.closest('form').find('input[name="productimage"]').val();

            // Remplir les champs de la modal avec les données du produit
            modal.find('#productName').val(productName);
            modal.find('#productDescription').val(productDescription);
            modal.find('#productPrice').val(productPrice);
            modal.find('#productStock').val(productStock);
            modal.find('#productImage').val(productImage);

            // Ajouter l'ID du produit au formulaire de la modal
            modal.find('#productForm').append('<input type="hidden" name="productid" value="' + productId + '">');
        });

        $('#submitProduct').on('click', function() {
            $('#productForm').submit();
        });
    });
</script>
</body>
</html>