<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</head>
<body>
<h1>Welcome to your Dashboard : <span th:text="${shopkeepers.websiteName}" style="text-decoration: darkblue underline;"></span></h1>
<card>
    <p th:text="${shopkeepers.firstName}"></p>
    <p th:text="${shopkeepers.lastName}"></p>
    <p th:text="${shopkeepers.email}"></p>
    <img th:src="@{${shopkeepers.profilePicture}}" alt="Photo de profil" style="width: 150px; height: 150px; border-radius: 50%;"/>
    <a href="/shopkeeper/accountUpdate"><button>Modifier</button></a>
</card>
<hr>

<!-- Bouton pour ouvrir la fenêtre modale -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addCategoryModal">
    Ajouter une catégorie
</button>

<!-- Fenêtre modale pour ajouter une catégorie -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Ajouter une catégorie</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <div class="form-group">
                        <label for="categoryName">Nom de la catégorie:</label>
                        <input type="text" class="form-control" id="categoryName" name="categoryName" required>
                    </div>
                    <div id="subcategoriesContainer">
                        <div class="form-group">
                            <label for="subcategories1">Sous-catégorie 1:</label>
                            <input type="text" class="form-control" id="subcategories1" name="subcategories">
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" id="addSubcategory">Ajouter une sous-catégorie</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="submitCategory">Ajouter</button>
            </div>
        </div>
    </div>
</div>

<div th:each="category : ${categoryList}" style="border: 1px solid black; margin-top: 2vh; margin-bottom: 2vh;">
    <h1 th:text="${category.CategoryName}" style="padding: 1.2vh;"></h1>
    <a th:href="'/shopkeeper/updateCategory?id=' + ${category.id}"><button>Modifier Catégorie</button></a>
    <a th:href="'/shopkeeper/supprCategory?id=' + ${category.id}"><button>Supprimer Catégorie</button></a>
    <a th:href="'/shopkeeper/addSubcategory?id=' + ${category.id}"><button>Ajout Sous Catégorie</button></a>

    <div th:each="subCategory : ${subCategoryList}" th:if="${subCategory.id_category == category.id}" style="border: 1px solid black;">
        <h2 th:text="${subCategory.SubCategoryName}" style="padding: 0.8vh; padding-left: 15vh;"></h2>
        <a th:href="'/shopkeeper/updateSubcategory?id=' + ${subCategory.id}"><button>Modifier Sous Catégorie</button></a>
        <a th:href="'/shopkeeper/supprSubcategory?id=' + ${subCategory.id}"><button>Supprimer Sous Catégorie</button></a>
        <a th:href="'/products/addProduct?id=' + ${subCategory.id}"><button>Ajout Produit</button></a>

        <div th:each="product : ${productList}" th:if="${product.id_subCategory == subCategory.id}" style="border: 1px solid black;">
            <p th:text="${product.productName}" style="padding: 0.6vh; margin-left: 25vh; margin-right: 25vh; font-weight: bold; font-size: large"></p>
            <p th:text="'Description : ' + ${product.description}" style="padding: 0.6vh; margin-left: 25vh; margin-right: 25vh;"></p>
            <p th:text="'Stock : ' + ${product.stock}" style="padding: 0.6vh; margin-left: 25vh; margin-right: 25vh;"></p>
            <p th:text="'Prix : ' + ${product.price}+ ' €'" style="padding: 0.6vh; margin-left: 25vh; margin-right: 25vh;"></p>
            <img th:src="@{${product.image}}" th:alt="'image du '+ ${product.productName}" style="width: 150px; height: 150px;"/>
            <a th:href="'/shopkeeper/updateProduct?id=' + ${product.id}"><button>Modifier Produit</button></a>
            <a th:href="'/shopkeeper/supprProduct?id=' + ${product.id}"><button>Supprimer Produit</button></a>
        </div>
    </div>
</div>

<!--
le script javascript ci-dessous gère l'ajout des sous-catég dans une fenêtre modale et envoie les dnnées au serveur via une requête ajax.
le nom du site web est récupéré à partir de thymeleaf ( [[${shopkeepers.websiteName}]] ).
-->

<script th:inline="javascript">
    $(document).ready(function() {
        var subcategoryCounter = 1;

        $('#addSubcategory').click(function() {
            subcategoryCounter++;
            var newSubcategory = `
                <div class="form-group">
                    <label for="subcategories${subcategoryCounter}">Sous-catégorie ${subcategoryCounter}:</label>
                    <input type="text" class="form-control" id="subcategories${subcategoryCounter}" name="subcategories">
                </div>
            `;
            $('#subcategoriesContainer').append(newSubcategory);
        });

        $('#submitCategory').click(function() {
            var categoryName = $('#categoryName').val();
            var subcategories = [];
            $('input[name="subcategories"]').each(function() {
                subcategories.push($(this).val());
            });

            var websiteName = [[${shopkeepers.websiteName}]];
            var csrfToken = $("input[name='_csrf']").val();

            $.ajax({
                url: '/categories',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken
                },
                data: {
                    action: 'ajoutcateg',
                    website_name: websiteName,
                    categories1: categoryName,
                    subcategories: subcategories
                },
                success: function(response) {
                    alert('Catégorie ajoutée avec succès!');
                    $('#addCategoryModal').modal('hide');

                },
                error: function(error) {
                    alert('Erreur lors de l\'ajout de la catégorie.');
                }
            });
        });
    });
</script>
</body>
</html>