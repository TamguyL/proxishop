<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard</title>
    <div th:insert="fragments/fragments :: headerfiles"></div>
</head>
<body>
<div class="container mt-5">
    <div th:insert="fragments/fragments :: headerProxi"></div>
    <h1>Welcome to your Dashboard : <span th:text="${shopkeepers.websiteName}" style="text-decoration: darkblue underline;"></span></h1>
    <div class="card mb-4">
        <div class="row p-3">
            <div class="col-md-5">
                <img th:src="@{${shopkeepers.profilePicture}}" alt="Photo de profil" style="width: 150px; height: 150px; border-radius: 50%;"/>
            </div>
            <div class="col-md-6">
                <h2 th:text="${shopkeepers.firstName}+' '+${shopkeepers.lastName}"  ></h2>
                <p th:text="${shopkeepers.email}"></p>
            </div>
            <div class="col-md-1">
                <a href="/shopkeeper/accountUpdate"><button class="btn btn-warning" title="Modifier le profil">‚úèÔ∏è</button></a>
            </div>
        </div>
    </div>


    <!-- AJOUTER CATEGORIE: Bouton pour ouvrir la fen√™tre modale -->
    <div class="d-flex flex-row-reverse me-3">
        <button type="button" class="justify-content-end btn btn-primary mb-3" title="Ajouter une categorie" data-toggle="modal" data-target="#addCategoryModal">
            ‚ûï
        </button>
    </div>

    <div th:insert="fragments/fragments :: information"></div>


    <!-- AJOUTER CATEGORIE: Fen√™tre modale pour ajouter une cat√©gorie -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Ajouter une cat√©gorie</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="form-group">
                            <label for="categoryName">Nom de la cat√©gorie:</label>
                            <input type="text" class="form-control" id="categoryName" name="categoryName" required>
                        </div>
                        <div id="subcategoriesContainer">
                            <div class="form-group">
                                <label for="subcategories1">Sous-cat√©gorie 1:</label>
                                <input type="text" class="form-control" id="subcategories1" name="subcategories">
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" id="addSubcategory">‚ûï</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" id="submitCategory">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <div th:each="category : ${categoryList}" class="border rounded p-3 mb-4">
        <div class="row">
            <!-- Chaque div occupe 3 colonnes (col-md-3) -->
            <div class="col-md-9 mx-auto">
                <h2 th:text="${category.CategoryName}" class="text-success text-center"></h2>
            </div>
            <div class="col-md-1">
                <a th:href="'/shopkeeper/updateCategory?id=' + ${category.id}"><button class="btn btn-warning" title="Modifier la Categorie">‚úèÔ∏è</button></a>
            </div>
            <div class="col-md-1">
                <a th:href="'/shopkeeper/supprCategory?id=' + ${category.id}"><button class="btn btn-danger me-4" title="Supprimer la Categorie">üóëÔ∏è</button></a>
            </div>
        </div>
        <div class="d-flex flex-row mt-4">
            <a th:href="'/shopkeeper/addSubcategory?id=' + ${category.id}"><button class="btn btn-primary" title="Ajouter une sous-categorie">‚ûï</button></a>
        </div>





        <div th:each="subCategory : ${subCategoryList}" th:if="${subCategory.id_category == category.id}" class="border-top pt-3">
            <div class="row">
                <div class="col-md-9 mx-auto">
                    <h3 th:text="${subCategory.SubCategoryName}" class="ms-3 text-center"></h3>
                </div>
                <div class="col-md-1">
                    <a th:href="'/shopkeeper/updateSubcategory?id=' + ${subCategory.id}"><button class="btn btn-warning" title="Modifier la sous-categorie">‚úèÔ∏è</button></a>
                </div>
                <div class="col-md-1">
                    <a th:href="'/shopkeeper/supprSubcategory?id=' + ${subCategory.id}"><button class="btn btn-danger" title="Supprimer la sous-categorie">üóëÔ∏è</button></a>
                </div>
            </div>

            <!--  AJOUT PRODUIT: ci-dessous transmission de l'id de la sous-cat√©gorie du produit en "hidden" et du csrf token   -->

            <div class="d-flex flex-row-reverse mt-4">
                <form method="post" action="/products/newProduct"> <!--bouton-->
                    <input type="hidden" th:value="${subCategory.id}" name="id_subcategory">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button class="btn btn-primary" title="Ajouter un produit">‚ûï</button>
                </form>
            </div>

            <!-- AFFICHAGE PRODUITS -->
            <div th:each="product : ${productList}" th:if="${product.id_subCategory == subCategory.id}" class="border rounded p-3 mb-4">
                <div class="row">
                    <div class="col-md-5 rounded">
                        <img th:src="@{${product.image}}" th:alt="'image de '+ ${product.productName}" class="rounded product-image"/>
                    </div>
                    <div class="col-md-6">
                        <div class="product-info">
                            <p th:text="${product.productName}" class="fw-bold fs-4"></p>
                            <p th:text="'Description : ' + ${product.description}"></p>
                            <p th:text="'Stock : ' + ${product.stock}"></p>
                            <p th:text="'Prix : ' + ${product.price}+ ' ‚Ç¨'" class="fw-bold fs-5"></p>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="d-flex flex-column">
                            <div class="p-4">
                                <!-- MODIFICATION PRODUIT -->
                                <form method="post" action="/products/updateProduct" >
                                    <input type="hidden" th:value="${product.id}" name="productid">
                                    <input type="hidden" th:value="${subCategory.id}" name="id_subcategory">
                                    <input type="hidden" th:value="${product.productName}" name="productName">
                                    <input type="hidden" th:value="${product.description}" name="productdescription">
                                    <input type="hidden" th:value="${product.price}" name="productprice">
                                    <input type="hidden" th:value="${product.stock}" name="productstock">
                                    <input type="hidden" th:value="${product.image}" name="file">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <input type="hidden" th:value="${product.id_subCategory}" th:name="id_subcategory" />

                                    <!--MODIFICATION PRODUIT: Bouton pour ouvrir la fen√™tre modale -->
                                    <!--- transmettre id produit ici!  title="Modifier le produit" -->

                                    <button class="btn btn-warning" title="Modifier le produit" type="button" data-toggle="modal" data-target="#updateProductModal" th:data-product-id="${product.id}" th:data-subcategory-id="${product.id_subCategory}">
                                        ‚úèÔ∏è
                                    </button>

                                </form>
                                <!-- MODIFICATION PRODUIT: Fen√™tre modale-->
                                <div class="modal fade" id="updateProductModal" tabindex="-1" role="dialog" aria-labelledby="updateProductModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="updateProductModalLabel">Modifier un Produit</h5>
                                                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="productForm" method="post" action="/products/updateProduct" enctype="multipart/form-data">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                    <input type="hidden" id="productid" th:name="productid" th:value="${product.id}" />
                                                    <input type="hidden" th:value="${subCategory.id}" name="id_subcategory" />

                                                    <div class="form-group">
                                                        <label for="productName">Nom du Produit:</label>
                                                        <input type="text"  class="form-control" id="productName" name="productName" th:value="${product.productName}" >
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="productDescription">Description:</label>
                                                        <textarea class="form-control" id="productDescription" th:name="productdescription" th:value="${product.description}" ></textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="productPrice">Prix:</label>
                                                        <input type="number" class="form-control" id="productPrice" th:name="productprice" th:value="${product.price}" >
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="productStock">Stock:</label>
                                                        <input type="number" class="form-control" id="productStock" th:name="productstock" th:value="${product.stock}" >
                                                    </div>
                                                    <div class="form-group">

                                                        <label for="file">Choisir une image produit:</label>
                                                        <input type="file" class="form-control" id="file" name="file" accept="image/png, image/jpeg, image/gif" /><br>

                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                                <button type="button" class="btn btn-primary" id="submitProduct">Modifier</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4">
                                <!--  SUPPRESSION PRODUIT: ci-dessous transmission de l'id et du nom du produit en "hidden" ainsi du csrf token   -->
                                <form method="post" action="/products/deleteProduct">
                                    <input type="hidden" th:value="${product.id}" name="productid">
                                    <input type="hidden" th:value="${product.productName}" name="productName">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button class="btn btn-danger" title="Supprimer le produit">üóëÔ∏è</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<!--
le script javascript ci-dessous g√®re l'ajout des sous-cat√©g dans une fen√™tre modale et envoie les dnn√©es au serveur via une requ√™te ajax.
le nom du site web est r√©cup√©r√© √† partir de thymeleaf ( [[${shopkeepers.websiteName}]] ).
-->

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var subcategoryCounter = 1;

        // Gestion de l'ajout de sous-cat√©gories dynamiques
        document.getElementById('addSubcategory').addEventListener('click', function() {
            subcategoryCounter++;
            var newSubcategory = `
            <div class="form-group">
                <label for="subcategories${subcategoryCounter}">Sous-cat√©gorie ${subcategoryCounter}:</label>
                <input type="text" class="form-control" id="subcategories${subcategoryCounter}" name="subcategories">
            </div>
        `;
            document.getElementById('subcategoriesContainer').insertAdjacentHTML('beforeend', newSubcategory);
        });

        // Soumission de la cat√©gorie
        document.getElementById('submitCategory').addEventListener('click', function() {
            var categoryName = document.getElementById('categoryName').value;
            var subcategories = [];
            document.querySelectorAll('input[name="subcategories"]').forEach(function(input) {
                subcategories.push(input.value);
            });

            var websiteName =[[${shopkeepers.websiteName}]];
            var csrfToken = document.querySelector('input[name="_csrf"]').value;

            // Requ√™te Fetch pour soumettre le formulaire d'ajout de cat√©gorie
            fetch('/categories', {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'ajoutcateg',
                    website_name: websiteName,
                    categories1: categoryName,
                    subcategories: subcategories
                })
            }).then(response => {
                if (response.ok) {
                    alert('Cat√©gorie ajout√©e avec succ√®s!');
                    // Fermer la modale apr√®s l'ajout de la cat√©gorie
                    var modalElement = document.getElementById('addCategoryModal');
                    var modal = bootstrap.Modal.getInstance(modalElement);
                    modal.hide();
                } else {
                    alert('Erreur lors de l\'ajout de la cat√©gorie.');
                }
            });
        });

        // Pr√©remplir le formulaire de modification de produit lors de l'ouverture de la modale
        var updateProductModal = document.getElementById('updateProductModal');
        updateProductModal.addEventListener('show.bs.modal', function(event) {
            var button = event.relatedTarget; // Bouton qui d√©clenche la modale
            var productId = button.getAttribute('data-product-id');
            var id_subcategory = button.getAttribute('data-subcategory-id');

            var modal = this;
            var form = modal.querySelector('#productForm');

            // Remplissage des champs avec les donn√©es actuelles du produit
            form.querySelector('#productName').value = button.getAttribute('data-product-name');
            form.querySelector('#productDescription').value = button.getAttribute('data-product-description');
            form.querySelector('#productPrice').value = button.getAttribute('data-product-price');
            form.querySelector('#productStock').value = button.getAttribute('data-product-stock');
            form.querySelector('#productid').value = productId; // Associer le bon ID de produit
        });

        // Soumission du formulaire de modification de produit
        document.getElementById('submitProduct').addEventListener('click', function() {
            var form = document.getElementById('productForm');
            var formData = new FormData(form);

            // Envoi du formulaire avec fetch
            fetch(form.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    alert('Produit modifi√© avec succ√®s!');
                    // Fermer la modale apr√®s la modification du produit
                    var modalElement = document.getElementById('updateProductModal');
                    var modal = bootstrap.Modal.getInstance(modalElement);
                    modal.hide();
                } else {
                    alert('Erreur lors de la modification du produit.');
                }
            });
        });
    });


    $(document).ready(function() {
        $('#updateProductModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget); // Bouton qui a d√©clench√© la modal
            var productId = button.data('product-id'); // R√©cup' ID produit
            var id_subcategory = button.data('subcategory-id'); // R√©cup' ID sous-categorie du produit

            var modal = $(this);

            // Charger les donn√©es du produit via AJAX ou directement depuis les champs cach√©s
            var productName = button.closest('form').find('input[name="productName"]').val();
            var productDescription = button.closest('form').find('input[name="productdescription"]').val();
            var productPrice = button.closest('form').find('input[name="productprice"]').val();
            var productStock = button.closest('form').find('input[name="productstock"]').val();
            var productImage = button.closest('form').find('input[name="productimage"]').val();




            // transmission donn√©es produi-modal
            modal.find('#productName').val(productName);
            modal.find('#productDescription').val(productDescription);
            modal.find('#productPrice').val(productPrice);
            modal.find('#productStock').val(productStock);
            modal.find('#productImage').val(productImage);

            // ajout des valeurs cach√©es au modal
            modal.find('#productForm').append('<input type="hidden" name="productid" value="' + productId + '">');
            modal.find('#productForm').append('<input type="hidden" name="id_subcategory" value="' + id_subcategory + '">');

            //logs pour v√©rif' erreur transmission
            console.log('Product ID:', productId);
            console.log('Product Name:', productName);
            console.log('Product Description:', productDescription);
            console.log('Product Price:', productPrice);
            console.log('Product Stock:', productStock);
            console.log('Product Image:', productImage);
            console.log('Subcategory ID:', id_subcategory);

        });

        $('#submitProduct').on('click', function() {
            $('#productForm').submit();
        });
    });
</script>
</body>
</html>